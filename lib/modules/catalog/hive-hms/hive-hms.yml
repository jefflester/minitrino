version: "3.7"
services:

  presto:
    environment:
      S3_ENDPOINT: "${S3_ENDPOINT}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY}"
      S3_SECRET_KEY: "${S3_SECRET_KEY}"
      REGION: "${REGION}"
    volumes:
      - "./modules/catalog/hive-hms/presto/hive_hms.properties:/usr/lib/presto/etc/catalog/hive_hms.properties:ro"
  
  postgres-hive-hms:
    image: "postgres:${POSTGRES_HIVE_HMS_VER}"
    container_name: "postgres-hive-hms"
    labels:
      - "com.starburst.tests=minipresto"
      - "com.starburst.tests.module.hive-hms=catalog-hive-hms"
    user: "postgres"
    env_file:
      - "./modules/catalog/hive-hms/hms/postgres.env"
    volumes:
      - "postgres-hive-hms-data:/var/lib/postgresql/data"
  
  metastore:
    image: "starburstdata/hive-metastore-unsecured"
    container_name: "metastore"
    labels:
      - "com.starburst.tests=minipresto"
      - "com.starburst.tests.module.hive-hms=catalog-hive-hms"
    depends_on:
      - "postgres-hive-hms"
    environment:
      HIVE_METASTORE_JDBC_URL: "jdbc:postgresql://postgres-hive-hms:5432/hivemetastore"
      HIVE_METASTORE_DRIVER: "org.postgresql.Driver"
      HIVE_METASTORE_USER: "hivemetastore"
      HIVE_METASTORE_PASSWORD: "hivemetastore"
      S3_ENDPOINT: "${S3_ENDPOINT}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY}"
      S3_SECRET_KEY: "${S3_SECRET_KEY}"
      REGION: "${REGION}"
      HIVE_METASTORE_URI: "metastore"
    volumes:
      - "./modules/resources/wait-for-it.sh:/etc/boot/wait-for-it.sh:ro"
    command: ["./etc/boot/wait-for-it.sh" , "postgres-hive-hms:5432" , "--strict" , "--timeout=60" , "--" , "./opt/bin/start-hive-metastore.sh"]
    ports:
      - "9083:9083"
  
volumes:
  postgres-hive-hms-data:
    labels:
      - "com.starburst.tests=minipresto"
      - "com.starburst.tests.module.hive-hms=catalog-hive-hms"
  