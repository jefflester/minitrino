{
  "tests": [
    {
      "type": "logs",
      "name": "Ensure HMS is running",
      "container": "metastore-hive-lib-test",
      "contains": [
        "Starting Metastore Server"
      ],
      "timeout": 60
    },
    {
      "type": "logs",
      "name": "Ensure post-start scripts finish",
      "container": "minitrino-lib-test",
      "contains": [
        "POST START BOOTSTRAPS COMPLETED"
      ],
      "timeout": 90
    },
    {
      "type": "query",
      "name": "Test create materialized view",
      "sql": "CREATE MATERIALIZED VIEW hive_mv_tsr.mvs.test AS SELECT * FROM tpch.tiny.orders UNION ALL SELECT * FROM tpch.tiny.orders",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "contains": [
        "CREATE MATERIALIZED VIEW"
      ],
      "retries": 30
    },
    {
      "type": "query",
      "name": "Test query materialized view - test",
      "sql": "SELECT * FROM hive_mv_tsr.mvs.test LIMIT 10",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "contains": [
        "orderkey",
        "custkey",
        "orderstatus"
      ]
    },
    {
      "type": "query",
      "name": "Test query materialized view - example",
      "sql": "SELECT * FROM hive_mv_tsr.mvs.example LIMIT 10",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "contains": [
        "orderkey",
        "orderdate"
      ]
    },
    {
      "type": "query",
      "name": "Test table scan redirection - customer",
      "sql": "SELECT * FROM postgres.public.customer LIMIT 10",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "contains": [
        "custkey",
        "name",
        "address"
      ]
    },
    {
      "type": "query",
      "name": "Test table scan redirection - orders",
      "sql": "SELECT * FROM postgres.public.orders LIMIT 10",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "contains": [
        "orderkey",
        "orderdate"
      ]
    },
    {
      "type": "query",
      "name": "Verify MV storage",
      "sql": "SHOW TABLES IN hive_mv_tsr.cache",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "retries": 90,
      "contains": [
        "customer_",
        "orders_"
      ]
    },
    {
      "type": "query",
      "name": "Verify TSR storage",
      "sql": "SHOW TABLES IN hive_mv_tsr.mv_storage",
      "trinoCliArgs": [
        "--server 'http://localhost:8080'",
        "--user admin"
      ],
      "retries": 90,
      "contains": [
        "example_",
        "test_"
      ]
    }
  ]
}
