---
services:

  minitrino:
    volumes:
      - ./modules/catalog/pinot/resources/cluster/pinot.properties:/mnt/etc/catalog/pinot.properties:ro

  pinot-zookeeper:
    image: zookeeper:${ZOOKEEPER_VER}
    container_name: pinot-zookeeper-${CLUSTER_NAME}
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    expose:
      - 2181
    volumes:
      - pinot-zookeeper-data:/data
      - pinot-zookeeper-datalog:/datalog
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true

  pinot-controller:
    image: apachepinot/pinot:${PINOT_VER}
    container_name: pinot-controller-${CLUSTER_NAME}
    command: StartController -zkAddress pinot-zookeeper:2181
    restart: unless-stopped
    env_file:
      - ./modules/catalog/pinot/resources/pinot/controller.env
    depends_on:
      - pinot-zookeeper
    ports:
      - ${__PORT_PINOT_CONTROLLER}:9000
    volumes:
      - pinot-controller-data:/tmp/data/PinotController
      - ./modules/catalog/pinot/resources/pinot/bootstrap.sh:/bootstrap.sh:ro
      - ./modules/catalog/pinot/resources/pinot/entrypoint-controller.sh:/entrypoint-controller.sh:ro
    entrypoint: ["/entrypoint-controller.sh"]
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true

  pinot-broker:
    image: apachepinot/pinot:${PINOT_VER}
    container_name: pinot-broker-${CLUSTER_NAME}
    command: StartBroker -zkAddress pinot-zookeeper:2181
    restart: unless-stopped
    env_file:
      - ./modules/catalog/pinot/resources/pinot/broker.env
    depends_on:
      - pinot-controller
    expose:
      - 8099
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true

  pinot-server:
    image: apachepinot/pinot:${PINOT_VER}
    container_name: pinot-server-${CLUSTER_NAME}
    command: StartServer -zkAddress pinot-zookeeper:2181
    restart: unless-stopped
    env_file:
      - ./modules/catalog/pinot/resources/pinot/server.env
    depends_on:
      - pinot-broker
    expose:
      - 8098
    volumes:
      - pinot-server-data:/tmp/data/pinotServerData
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true

volumes:
  pinot-zookeeper-data:
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true
  pinot-zookeeper-datalog:
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true
  pinot-controller-data:
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true
  pinot-server-data:
    labels:
      - org.minitrino.root=true
      - org.minitrino.module.catalog.pinot=true
