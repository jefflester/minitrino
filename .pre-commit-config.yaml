---
# Minitrino Pre-commit Configuration
# Enforces code quality, formatting, and project standards

exclude: ^(venv/|build/|dist/|\.eggs/)

repos:
  # ============================================================================
  # Code Formatting & Style
  # ============================================================================

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.4
    hooks:
      - id: ruff
        name: Ruff linter
        args: [--fix]
      - id: ruff-format
        name: Ruff formatter

  - repo: local
    hooks:
      - id: docformatter
        name: Format docstrings
        description: Format docstrings to 88 characters
        entry: docformatter
        language: python
        types: [python]
        additional_dependencies: [docformatter]
        args: [
          "--wrap-summaries", "88",
          "--wrap-descriptions", "88",
          "--in-place"
        ]
        exclude: ^docs/conf.py

  # ============================================================================
  # General File Checks
  # ============================================================================

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-yaml
      - id: check-toml
      - id: check-json
      - id: check-merge-conflict
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-added-large-files
        args: ['--maxkb=1000']

  # ============================================================================
  # Linting & Quality
  # ============================================================================

  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        args: [-c, .yamllint]

  - repo: https://github.com/executablebooks/mdformat
    rev: 0.7.22
    hooks:
      - id: mdformat
        additional_dependencies:
          - mdformat-myst
          - mdformat-gfm

  - repo: https://github.com/crate-ci/typos
    rev: v1.39.0
    hooks:
      - id: typos
        files: \.(md|rst|txt)$

  # ============================================================================
  # Python Type Checking & Documentation
  # ============================================================================

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.18.1
    hooks:
      - id: mypy
        additional_dependencies:
          - mypy-extensions
          - types-click
          - types-docker
          - types-PyYAML
          - types-jsonschema
          - types-setuptools
          - types-tabulate
          - types-python-dateutil
        exclude: docs/conf.py

  - repo: https://github.com/pycqa/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        additional_dependencies: [tomli]
        exclude: 'docs/conf.py|.precommit/.*'

  # ============================================================================
  # Security & Code Quality Analysis (Informational)
  # ============================================================================

  - repo: local
    hooks:
      - id: bandit
        name: bandit (informational)
        entry: bash -c 'venv/bin/bandit -r src/cli/ --skip B101,B603 -q || true'
        language: system
        types: [python]
        pass_filenames: false
        verbose: true

      - id: vulture
        name: Log unused code (vulture)
        entry: .precommit/run-vulture.sh
        language: script
        types: [python]
        pass_filenames: false

      - id: deptry
        name: Check dependency usage (deptry)
        entry: bash -c 'venv/bin/deptry . || true'
        language: system
        types: [python]
        pass_filenames: false
        verbose: true

  # ============================================================================
  # Shell Scripts
  # ============================================================================

  - repo: https://github.com/koalaman/shellcheck-precommit
    rev: v0.11.0
    hooks:
      - id: shellcheck
        name: shellcheck
        entry: shellcheck
        language: system
        types: [shell]

  # ============================================================================
  # Docker Files
  # ============================================================================

  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker
        args: [--ignore, DL3008, --ignore, DL3009]

  # ============================================================================
  # JSON Formatting
  # ============================================================================

  - repo: local
    hooks:
      - id: jq-format
        name: Format JSON with jq
        entry: |-
          bash -c '
          modified=()
          for file in $(
            find src/ -type d -name ".*" -prune -o -name "*.json" -print
          ); do
            tmpfile=$(mktemp)
            if ! jq . "$file" > "$tmpfile"; then
              echo "Failed to process $file"
              exit 1
            fi
            if ! cmp -s "$file" "$tmpfile"; then
              mv "$tmpfile" "$file"
              echo "$file"
              modified+=("$file")
            else
              rm "$tmpfile"
            fi
          done
          echo "Total modified JSON files: ${#modified[@]}"
          '
        language: system
        files: \.json$
        always_run: true
        pass_filenames: false

  # ============================================================================
  # Project-Specific Maintenance
  # ============================================================================

  - repo: local
    hooks:
      - id: update-switcher-json
        name: Update Sphinx Switcher JSON
        entry: python .precommit/update_switcher_json.py
        language: python
        pass_filenames: false

      - id: sync-cluster-version
        name: Sync cluster version across files
        entry: python .precommit/sync_cluster_version.py
        language: python
        files: ^src/lib/minitrino.env|src/lib/docker-compose.yaml|src/cli/minitrino/settings.py

      - id: sync-version-files
        name: Sync version files to branch name
        entry: python .precommit/sync_version_files.py
        language: python
        pass_filenames: false
        always_run: true

  # ============================================================================
  # Validation & Testing
  # ============================================================================

  - repo: local
    hooks:
      - id: validate-pytest-collection
        name: Validate tests can be collected
        entry: bash -lc '.precommit/validate_pytest_collection.sh'
        language: system
        pass_filenames: false
        files: ^src/tests/.*\.py$
        description: Ensure pytest can collect all tests without errors

  # ============================================================================
  # CI/CD Workflows
  # ============================================================================

  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.8
    hooks:
      - id: actionlint
        args: [-shellcheck=, -pyflakes=]
